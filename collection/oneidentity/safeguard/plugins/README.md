# Safeguard Collection Plugins Directory

The Safeguard resource for Ansible collection includes a lookup plugin that allows Ansible to pull credentials from Safeguard for Privileged Passwords (SPP). A lookup plugin can be used anywhere you can use templating in Ansible such as in playbooks, variable files, inventory files, etc. The following includes some examples of how to use the Safeguard credentials lookup plugin.

## Safeguard Credentials lookup plugin

The Safeguard Credentials lookup plugin allows Ansible to fetch a credential from SPP through the Application to Application (A2A) API. This requires that an A2A registration has been created in SPP. For more information about how to create an A2A registration, please see the Safeguard for Privileged Passwords Administration Guide for your version of SPP (<https://support.oneidentity.com/technical-documents>).

### Prerequisites

All of the Safeguard plugins have a dependency on One Identity PySafeguard python module. PySafeguard provides a native python client library for accessing the SPP appliance. PySafeguard can be installed by running the following command (also tenacity is needed to retry password checkout if it fails):

```text
> python3 -m pip install pysafeguard==7.4.0 tenacity==8.3.0
```

For more information about PySafeguard, please see <https://github.com/OneIdentity/PySafeguard>.

### Installation

Installation of the Safeguard collection must be done using the Ansible-Galaxy command line tool. There are several options for installing the Safeguard collection for Ansible.

#### Installing from the Ansible Galaxy repository

From the Ansible host computer, run the following command:

```text
> ansible-galaxy collection install oneidentity.safeguardcollection -p <your-collection-location>
```

#### Installing from the tarball

1. Download the latest release tarball from the safeguard-ansible GitHub repository to the Ansible controller node. (<https://github.com/OneIdentity/safeguard-ansible/releases>).
2. Install the Safeguard resource collection using the ansible-galaxy command line tool.

```text
> ansible-galaxy collection install oneidentity-safeguardcollection-<version>.tar.gz -p <your-collection-location>
```

#### Installing from the GitHub repository

1. Install the Safeguard resource collection using the ansible-galaxy command line utility and providing it with the source location.

```text
> ansible-galaxy collection install git+https://github.com/OneIdentity/safeguard-ansible/collection/oneidenity/safeguard,<branch || tag> -p <your-collection-location>
```

### Configuration

When an A2A registration is created in SPP, there are several pieces of information that must be used by the third-party application in order to access and fetch the associated credential. This information includes:

* A2A API key that identifies the specific credential
* A client authentication certificate file (PEM format)
* A client authentication private key (PEM format)
* The TLS public certificate used to verify the SPP appliance
* The type of credential to retrieve - password (default) or privatekey

Given this information from an A2A registration, the Safeguard credential lookup plugin will be able to fetch the associated credential from SPP.

The Safeguard Credential lookup plugin takes 2 parameters in addition to the plugin name.

```yaml
vars:
  spp_a2a_apikey: +IWSU/0msm98hUUUen5xOnYZZytVN2o9hLFxVr9S80Q=
  a2aconnectioninfo:
      spp_appliance: 192.168.1.234
      spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
      spp_certificate_key: /etc/ansible/spp/a2ausercert.key
      spp_tls_cert: /etc/ansible/spp/spptlscert.pem
      spp_credential_type: password
  spp_credential: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_a2a_apikey, a2aconnection=a2aconnectioninfo)}}"
```

Parameters:

* **spp_a2a_apikey** - The API key is generated by SPP when an A2A registration is created. The API key identifies a specific credential which can be fetched by a third-party application from SPP through the A2A interface.
* **a2aconnectioninfo** - A dictionary of information needed to connect to the SPP appliance.
  * **spp_appliance** - The IP address or host name of the SPP appliance.
  * **spp_certificate_file** - The full path to the user authentication certificate (PEM format).
  * **spp_certificate_key** - The full path to the user authentication private key (PEM format). NOTE: It is the responsibility of the Ansible administrator to make sure that the private key is stored in a safe location and can only be read by Ansible.
  * **spp_tls_cert** (optional) - The full path to the TLS public certificate that is associated with the SPP appliance. If this certificate path is not provided, the lookup plugin will disable TLS validation which may produce a warning.
  * **spp_credential_type** (optional) - The type of credential that should be retrieved from SPP. Must be **password** (default) or **privatekey**.

## Examples

Inventory file:

```yaml
linuxservers:
  vars:
    ansible_python_interpreter: /usr/bin/python3
    a2aconnectioninfo:
      spp_appliance: 192.168.1.234
      spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
      spp_certificate_key: /etc/ansible/spp/a2ausercert.key
      spp_tls_cert: /etc/ansible/spp/spptlscert.pem
      spp_credential_type: password
  hosts:
    vm01:
      spp_credential_1: safyBECB8SW5g0Udk7GRFh6LaQ/KoI0eNOW4JK8Cqeo=
      ansible_host: 192.168.2.34
      ansible_user: serviceadmin1
      ansible_password: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_credential_1, a2aconnection=a2aconnectioninfo)}}"
    vm02:
      spp_credential_2: ekmiCM/HcEOyIuBfOg2rLwtcH9qcykO9T+He0ySGbKY=
      ansible_host: 192.168.2.35
      ansible_user: serviceadmin2
      ansible_password: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_credential_2, a2aconnection=a2aconnectioninfo)}}"
```

Variables file:

```yaml
ansible_python_interpreter: /usr/bin/python3
a2aconnectioninfo:
    spp_appliance: 192.168.1.234
    spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
    spp_certificate_key: /etc/ansible/spp/a2ausercert.key
    spp_tls_cert: /etc/ansible/spp/spptlscert.pem
    spp_credential_type: password
spp_credential: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_credential_apikey, a2aconnection=a2aconnectioninfo)}}"
```

Playbook file:

```yaml
- name: SPP Test Playbook
  hosts: all
  vars:
    spp_credential_apikey: +IWSU/0msm98hUUUen5xOnYZZytVN2o9hLFxVr9S80Q=
    my_spp_appliance: 192.168.1.234
    my_spp_certificate_file: /etc/ansible/spp/a2ausercert.pem
    my_spp_certificate_key: /etc/ansible/spp/a2ausercert.key
    my_spp_tls_cert: /etc/ansible/spp/spptlscert.pem
    a2apasswordconnectioninfo:
      spp_appliance: "{{ my_spp_appliance }}"
      spp_certificate_file: "{{ my_spp_certificate_file }}"
      spp_certificate_key: "{{ my_spp_certificate_key }}"
      spp_tls_cert: "{{ my_spp_tls_cert }}"
      spp_credential_type: password
    a2aprivatekeyconnectioninfo:
      spp_appliance: "{{ my_spp_appliance }}"
      spp_certificate_file: "{{ my_spp_certificate_file }}"
      spp_certificate_key: "{{ my_spp_certificate_key }}"
      spp_tls_cert: "{{ my_spp_tls_cert }}"
      spp_credential_type: privatekey
  tasks:
    - name: Get the account password
      set_fact:
        my_password: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_credential_apikey, a2aconnection=a2apasswordconnectioninfo)}}"
        my_privatekey: "{{lookup('oneidentity.safeguardcollection.safeguardcredentials', spp_credential_apikey, a2aconnection=a2aprivatekeyconnectioninfo)}}"
```
